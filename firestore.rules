rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Posts collection
    match /posts/{postId} {
      // Leitura: Qualquer usuário autenticado pode ler posts
      allow read: if request.auth != null;
      
      // Criação: Apenas usuário autenticado, userId deve corresponder ao autor
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      
      // Atualização: Apenas o autor do post
      allow update: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
      
      // Exclusão: Apenas o autor do post
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
      
      // Subcoleção: Avaliações de posts (posts/{postId}/ratings)
      match /ratings/{ratingId} {
        // Leitura: Qualquer usuário autenticado pode ler avaliações
        allow read: if request.auth != null;
        
        // Escrita: Apenas usuários autenticados podem avaliar
        allow create: if request.auth != null 
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.postId == postId
                      && request.resource.data.rating is int
                      && request.resource.data.rating >= 1
                      && request.resource.data.rating <= 5;
        allow update: if request.auth != null 
                      && resource.data.userId == request.auth.uid
                      && request.resource.data.rating is int
                      && request.resource.data.rating >= 1
                      && request.resource.data.rating <= 5;
        allow delete: if request.auth != null 
                      && resource.data.userId == request.auth.uid;
      }
      
      // Subcoleção: Comentários de posts (posts/{postId}/comments)
      match /comments/{commentId} {
        // Leitura: Qualquer usuário autenticado pode ler comentários
        allow read: if request.auth != null;
        
        // Escrita: Apenas usuários autenticados podem comentar
        allow create: if request.auth != null 
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.postId == postId;
        allow update: if request.auth != null 
                      && resource.data.userId == request.auth.uid;
        allow delete: if request.auth != null 
                      && resource.data.userId == request.auth.uid;
      }
    }
    
    // Users collection - documentos de usuário
    match /users/{userId} {
      // Permite leitura e escrita para o próprio usuário (incluindo notificationSettings e privacySettings)
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
      
      // Subcoleção: Serviços do usuário (users/{userId}/services)
      match /services/{serviceId} {
        // Leitura: Qualquer usuário autenticado pode ler (para visualização pública)
        allow read: if request.auth != null;
        
        // Escrita: Apenas o dono do serviço (userId da subcoleção)
        allow create: if request.auth != null 
                      && request.auth.uid == userId
                      && request.resource.data.providerId == userId;
        allow update: if request.auth != null 
                      && request.auth.uid == userId
                      && resource.data.providerId == userId;
        allow delete: if request.auth != null 
                      && request.auth.uid == userId;
      }
      
      // Subcoleção: Produtos do usuário (users/{userId}/products)
      match /products/{productId} {
        // Leitura: Qualquer usuário autenticado pode ler (para visualização pública)
        allow read: if request.auth != null;
        
        // Escrita: Apenas o dono do produto (userId da subcoleção)
        allow create: if request.auth != null 
                      && request.auth.uid == userId
                      && request.resource.data.sellerId == userId;
        allow update: if request.auth != null 
                      && request.auth.uid == userId
                      && resource.data.sellerId == userId;
        allow delete: if request.auth != null 
                      && request.auth.uid == userId;
      }
      
      // Subcoleção: Ordens do usuário (users/{userId}/orders)
      match /orders/{orderId} {
        // Leitura: Apenas o dono (cliente) ou prestador relacionado
        allow read: if request.auth != null 
                    && (request.auth.uid == userId 
                        || resource.data.clientId == request.auth.uid 
                        || resource.data.providerId == request.auth.uid);
        
        // Escrita: Apenas o dono (cliente que criou a ordem)
        allow create: if request.auth != null 
                      && request.auth.uid == userId
                      && request.resource.data.clientId == userId;
        allow update: if request.auth != null 
                      && (request.auth.uid == userId 
                          || resource.data.clientId == request.auth.uid 
                          || resource.data.providerId == request.auth.uid);
        allow delete: if request.auth != null 
                      && request.auth.uid == userId;
      }
      
      // Subcoleção: Posts do usuário (users/{userId}/posts)
      match /posts/{postId} {
        // Leitura: Qualquer usuário autenticado pode ler (para visualização pública)
        allow read: if request.auth != null;
        
        // Escrita: Apenas o dono do post (userId da subcoleção)
        allow create: if request.auth != null 
                      && request.auth.uid == userId
                      && request.resource.data.userId == userId;
        allow update: if request.auth != null 
                      && request.auth.uid == userId
                      && resource.data.userId == userId;
        allow delete: if request.auth != null 
                      && request.auth.uid == userId;
      }
      
      // Subcoleção: Interesses em posts (users/{userId}/postInterests)
      match /postInterests/{interestId} {
        // Leitura: Apenas o próprio usuário pode ler seus interesses
        allow read: if request.auth != null 
                    && request.auth.uid == userId;
        
        // Escrita: Apenas o próprio usuário pode criar/atualizar seus interesses
        allow create: if request.auth != null 
                      && request.auth.uid == userId
                      && request.resource.data.postId is string
                      && request.resource.data.isInterested is bool;
        allow update: if request.auth != null 
                      && request.auth.uid == userId;
        allow delete: if request.auth != null 
                      && request.auth.uid == userId;
      }
      
      // Subcoleção: Usuários bloqueados (users/{userId}/blockedUsers)
      match /blockedUsers/{blockId} {
        // Leitura: Apenas o próprio usuário pode ler sua lista de bloqueados
        allow read: if request.auth != null 
                    && request.auth.uid == userId;
        
        // Escrita: Apenas o próprio usuário pode bloquear/desbloquear
        allow create: if request.auth != null 
                      && request.auth.uid == userId
                      && request.resource.data.blockedId is string
                      && request.resource.data.blockedId != userId; // Não pode bloquear a si mesmo
        allow update: if request.auth != null 
                      && request.auth.uid == userId;
        allow delete: if request.auth != null 
                      && request.auth.uid == userId;
      }
      
      // Subcoleção: Stories do usuário (users/{userId}/stories)
      match /stories/{storyId} {
        // Leitura: Qualquer usuário autenticado pode ler (para visualização pública)
        allow read: if request.auth != null;
        
        // Escrita: Apenas o dono da story (userId da subcoleção)
        allow create: if request.auth != null 
                      && request.auth.uid == userId
                      && request.resource.data.userId == userId;
        allow update: if request.auth != null 
                      && request.auth.uid == userId
                      && resource.data.userId == userId;
        allow delete: if request.auth != null 
                      && request.auth.uid == userId;
      }
    }
    
    // Coleção pública de serviços (para queries eficientes)
    match /services/{serviceId} {
      // Leitura: Qualquer usuário autenticado pode ler
      allow read: if request.auth != null;
      
      // Escrita: Apenas o prestador dono do serviço
      allow create: if request.auth != null 
                    && request.resource.data.providerId == request.auth.uid;
      allow update: if request.auth != null 
                    && resource.data.providerId == request.auth.uid;
      allow delete: if request.auth != null 
                    && resource.data.providerId == request.auth.uid;
    }
    
    // Coleção pública de produtos (para queries eficientes)
    match /products/{productId} {
      // Leitura: Qualquer usuário autenticado pode ler
      allow read: if request.auth != null;
      
      // Escrita: Apenas o vendedor dono do produto
      allow create: if request.auth != null 
                    && request.resource.data.sellerId == request.auth.uid;
      allow update: if request.auth != null 
                    && resource.data.sellerId == request.auth.uid;
      allow delete: if request.auth != null 
                    && resource.data.sellerId == request.auth.uid;
    }
    
    // Coleção pública de ordens (para prestadores verem ordens pendentes)
    match /orders/{orderId} {
      // Leitura: Qualquer usuário autenticado pode ler (para prestadores verem ordens)
      allow read: if request.auth != null;
      
      // Escrita: Apenas o cliente que criou ou prestador relacionado
      allow create: if request.auth != null 
                    && request.resource.data.clientId == request.auth.uid;
      allow update: if request.auth != null 
                    && (resource.data.clientId == request.auth.uid 
                        || resource.data.providerId == request.auth.uid);
      allow delete: if request.auth != null 
                    && resource.data.clientId == request.auth.uid;
    }
    
    // Outras coleções existentes (notifications, reviews, etc.)
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null 
                         && resource.data.userId == request.auth.uid;
    }
    
    match /reviews/{reviewId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null 
                   && request.resource.data.clientId == request.auth.uid;
    }
    
    // Story Views Collection (analytics)
    match /story_views/{storyId} {
      // Leitura: Apenas o dono da story pode ler analytics
      allow read: if request.auth != null 
                  && get(/databases/$(database)/documents/stories/$(storyId)).data.userId == request.auth.uid;
      
      // Escrita de views: Qualquer usuário autenticado pode registrar visualização
      match /views/{userId} {
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Escrita de ações: Qualquer usuário autenticado pode registrar ações
      match /actions/{actionId} {
        allow write: if request.auth != null 
                     && request.resource.data.userId == request.auth.uid;
      }
      
      // Escrita de interações: Qualquer usuário autenticado pode registrar interações
      match /interactions/{interactionId} {
        allow write: if request.auth != null 
                     && request.resource.data.userId == request.auth.uid;
      }
    }
    
    // Stories collection (pública)
    match /stories/{storyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;

      match /views/{userId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      }
    }

  // AI Conversations collection
  match /conversations/{conversationId} {
    // Users can only read their own conversations
    allow read: if request.auth != null && 
      resource.data.userId == request.auth.uid;
    
    // Users can only create conversations for themselves
    allow create: if request.auth != null && 
      request.resource.data.userId == request.auth.uid;
    
    // Users can only update their own conversations
    allow update: if request.auth != null && 
      resource.data.userId == request.auth.uid;
    
    // Users can only delete their own conversations
    allow delete: if request.auth != null && 
      resource.data.userId == request.auth.uid;
    
    // Messages subcollection
    match /messages/{messageId} {
      // Users can only read messages from their own conversations
      allow read: if request.auth != null && 
        get(/databases/{database}/documents/conversations/$(conversationId)).data.userId == request.auth.uid;
      
      // Only Cloud Functions can create messages (via server-side logic)
      allow create: if request.auth != null && 
        get(/databases/{database}/documents/conversations/$(conversationId)).data.userId == request.auth.uid;
      
      // Messages are immutable (no update/delete)
      allow update, delete: if false;
    }
  }
  
  // AI Usage analytics (read-only for users, write via Cloud Functions)
  match /ai_usage/{usageId} {
    // Users can only read their own usage
    allow read: if request.auth != null && 
      resource.data.userId == request.auth.uid;
    
    // Only Cloud Functions can write (via server-side logic)
    allow write: if false;
  }
  
  // Moderation logs (admin only)
  match /moderation_logs/{logId} {
    // Only admins can read moderation logs
    allow read: if false; // TODO: Add admin check if needed
    allow write: if false; // Only Cloud Functions can write
  }
  
    // Bank accounts collection
    match /bank_accounts/{accountId} {
      // Leitura (get/list): avaliada por documento; garante owner
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;
    
    // Users can only create bank accounts for themselves
    allow create: if request.auth != null 
                  && request.resource.data.userId == request.auth.uid
                  && request.resource.data.keys().hasAll(['userId', 'bankName', 'bankCode', 'agency', 'account', 'accountType', 'accountHolderName', 'accountHolderDocument', 'accountHolderDocumentType', 'isDefault'])
                  && request.resource.data.bankName is string && request.resource.data.bankName.size() > 0
                  && request.resource.data.bankCode is string && request.resource.data.bankCode.size() > 0
                  && request.resource.data.agency is string && request.resource.data.agency.size() >= 4 && request.resource.data.agency.size() <= 5
                  && request.resource.data.account is string && request.resource.data.account.size() >= 5 && request.resource.data.account.size() <= 12
                  && request.resource.data.accountType is string && (request.resource.data.accountType == "CHECKING" || request.resource.data.accountType == "SAVINGS")
                  && request.resource.data.accountHolderName is string && request.resource.data.accountHolderName.size() >= 3
                  && request.resource.data.accountHolderDocument is string && request.resource.data.accountHolderDocument.size() >= 11 && request.resource.data.accountHolderDocument.size() <= 14
                  && request.resource.data.accountHolderDocumentType is string && (request.resource.data.accountHolderDocumentType == "CPF" || request.resource.data.accountHolderDocumentType == "CNPJ")
                  && request.resource.data.isDefault is bool;
    
    // Users can update their own bank accounts
    // Permitir atualização completa ou parcial (apenas isDefault)
    allow update: if request.auth != null 
                  && resource.data.userId == request.auth.uid
                  && (
                    (
                      request.resource.data.keys().hasAll(['userId', 'bankName', 'bankCode', 'agency', 'account', 'accountType', 'accountHolderName', 'accountHolderDocument', 'accountHolderDocumentType', 'isDefault'])
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.bankName is string && request.resource.data.bankName.size() > 0
                      && request.resource.data.bankCode is string && request.resource.data.bankCode.size() > 0
                      && request.resource.data.agency is string && request.resource.data.agency.size() >= 4 && request.resource.data.agency.size() <= 5
                      && request.resource.data.account is string && request.resource.data.account.size() >= 5 && request.resource.data.account.size() <= 12
                      && request.resource.data.accountType is string && (request.resource.data.accountType == "CHECKING" || request.resource.data.accountType == "SAVINGS")
                      && request.resource.data.accountHolderName is string && request.resource.data.accountHolderName.size() >= 3
                      && request.resource.data.accountHolderDocument is string && request.resource.data.accountHolderDocument.size() >= 11 && request.resource.data.accountHolderDocument.size() <= 14
                      && request.resource.data.accountHolderDocumentType is string && (request.resource.data.accountHolderDocumentType == "CPF" || request.resource.data.accountHolderDocumentType == "CNPJ")
                      && request.resource.data.isDefault is bool
                    )
                    ||
                    (
                      request.resource.data.keys().hasOnly(['isDefault']) &&
                      request.resource.data.isDefault is bool
                    )
                  );
    
    // Users can only delete their own bank accounts
    allow delete: if request.auth != null 
                 && resource.data.userId == request.auth.uid;
  }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
