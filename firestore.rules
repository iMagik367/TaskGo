rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Obtém o role do usuário através de Custom Claims (autoridade única)
    function getUserRole() {
      return request.auth.token.role;
    }
    
    // Verifica se o usuário é admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Verifica se o usuário é moderador ou admin
    function isModeratorOrAdmin() {
      return isAuthenticated() && (getUserRole() == 'moderator' || getUserRole() == 'admin');
    }
    
    // Verifica se o usuário é o dono do recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // USERS COLLECTION
    // ==========================================
    
    match /users/{userId} {
      // Leitura: Próprio usuário, moderadores e admins
      allow read: if isOwner(userId) || isModeratorOrAdmin();
      
      // Criação: Apenas o próprio usuário pode criar seu documento inicial
      // Role é definido por Cloud Functions (setInitialUserRole)
      allow create: if isOwner(userId) 
                    && request.resource.data.uid == userId
                    && request.resource.data.keys().hasAll(['uid', 'email']);
      
      // Atualização: Apenas o próprio usuário pode atualizar (exceto role)
      // Role só pode ser alterado por admins via Cloud Functions
      allow update: if isOwner(userId)
                    && !('role' in request.resource.data.diff(resource.data).affectedKeys())
                    && !('roleUpdatedAt' in request.resource.data.diff(resource.data).affectedKeys())
                    && !('roleUpdatedBy' in request.resource.data.diff(resource.data).affectedKeys());
      
      // Admins podem atualizar qualquer campo (incluindo role) - mas usar Cloud Functions preferencialmente
      allow update: if isAdmin();
      
      // Exclusão: Apenas admins ou o próprio usuário (através de Cloud Function)
      allow delete: if isAdmin();
      
      // Subcoleções de usuário
      match /services/{serviceId} {
        // Leitura: Apenas leitura através de Cloud Functions
        // App não deve ler diretamente - usar Cloud Functions
        allow read: if isAuthenticated();
        
        // Escrita: BLOQUEADA - usar Cloud Functions (createService, updateService, deleteService)
        allow write: if false;
      }
      
      match /products/{productId} {
        // Leitura: Apenas leitura através de Cloud Functions
        allow read: if isAuthenticated();
        
        // Escrita: BLOQUEADA - usar Cloud Functions (createProduct, updateProduct, deleteProduct)
        allow write: if false;
      }
      
      match /orders/{orderId} {
        // Leitura: Cliente ou prestador relacionado, ou admins
        allow read: if isOwner(userId) 
                    || (isAuthenticated() && (
                        resource.data.clientId == request.auth.uid 
                        || resource.data.providerId == request.auth.uid
                        || isAdmin()
                      ));
        
        // Escrita: BLOQUEADA - usar Cloud Functions (createOrder, updateOrderStatus)
        allow write: if false;
      }
      
      match /posts/{postId} {
        allow read: if isAuthenticated();
        allow create: if isOwner(userId) 
                      && request.resource.data.userId == userId;
        allow update, delete: if isOwner(userId) 
                              && resource.data.userId == userId;
      }
      
      match /postInterests/{interestId} {
        allow read, write: if isOwner(userId);
      }
      
      match /blockedUsers/{blockId} {
        allow read, write: if isOwner(userId);
      }
      
      match /stories/{storyId} {
        allow read: if isAuthenticated();
        allow create: if isOwner(userId) 
                      && request.resource.data.userId == userId;
        allow update, delete: if isOwner(userId) 
                              && resource.data.userId == userId;
      }
    }
    
    // ==========================================
    // SERVICES COLLECTION (pública)
    // ==========================================
    
    match /services/{serviceId} {
      // Leitura: Qualquer usuário autenticado pode ler serviços ativos
      allow read: if isAuthenticated() 
                  && (resource.data.active == true);
      
      // Escrita: BLOQUEADA - usar Cloud Functions (createService, updateService, deleteService)
      // App não pode criar/editar serviços diretamente
      allow write: if false;
    }
    
    // ==========================================
    // PRODUCTS COLLECTION (pública)
    // ==========================================
    
    match /products/{productId} {
      // Leitura: Apenas produtos com status "active" são públicos
      allow read: if isAuthenticated() 
                  && resource.data.status == 'active'
                  && resource.data.active == true;
      
      // Escrita: BLOQUEADA - usar Cloud Functions (createProduct, updateProduct, deleteProduct)
      // App não pode criar/editar produtos diretamente
      allow write: if false;
    }
    
    // ==========================================
    // ORDERS COLLECTION (pública)
    // ==========================================
    
    match /orders/{orderId} {
      // Leitura: Cliente ou prestador relacionado, ou admins
      allow read: if isAuthenticated() 
                  && (resource.data.clientId == request.auth.uid 
                      || resource.data.providerId == request.auth.uid
                      || isAdmin());
      
      // Escrita: BLOQUEADA - usar Cloud Functions (createOrder, updateOrderStatus)
      // App não pode criar/editar ordens diretamente
      // Transições de status são validadas pela Cloud Function
      allow write: if false;
    }
    
    // ==========================================
    // POSTS COLLECTION
    // ==========================================
    
    match /posts/{postId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() 
                            && resource.data.userId == request.auth.uid;
      
      match /ratings/{ratingId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() 
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.postId == postId
                      && request.resource.data.rating is int
                      && request.resource.data.rating >= 1
                      && request.resource.data.rating <= 5;
        allow update, delete: if isAuthenticated() 
                              && resource.data.userId == request.auth.uid;
      }
      
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() 
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.postId == postId;
        allow update, delete: if isAuthenticated() 
                              && resource.data.userId == request.auth.uid;
      }
    }
    
    // ==========================================
    // CONVERSATIONS COLLECTION
    // ==========================================
    
    match /conversations/{conversationId} {
      // Apenas participantes podem ler
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
      
      match /messages/{messageId} {
        // Apenas participantes podem ler
        allow read: if isAuthenticated() 
                    && get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid;
        
        // Mensagens podem ser criadas por participantes (ou via Cloud Function)
        allow create: if isAuthenticated() 
                      && get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid;
        
        // Mensagens são imutáveis
        allow update, delete: if false;
      }
    }
    
    // ==========================================
    // NOTIFICATIONS COLLECTION
    // ==========================================
    
    match /notifications/{notificationId} {
      // Apenas o dono pode ler suas notificações
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Escrita: Apenas Cloud Functions podem criar notificações
      allow write: if false;
    }
    
    // ==========================================
    // REVIEWS COLLECTION
    // ==========================================
    
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      
      // Escrita: Apenas Cloud Functions podem criar reviews
      // Validações de estado devem ser feitas na Cloud Function
      allow write: if false;
    }
    
    // ==========================================
    // STORIES COLLECTION
    // ==========================================
    
    match /stories/{storyId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() 
                            && resource.data.userId == request.auth.uid;
      
      match /views/{userId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() 
                      && request.auth.uid == userId;
        allow update, delete: if false;
      }
    }
    
    // ==========================================
    // BANK ACCOUNTS COLLECTION
    // ==========================================
    
    match /bank_accounts/{accountId} {
      // Leitura: Apenas o dono
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Criação: Apenas o próprio usuário
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['userId', 'bankName', 'bankCode', 'agency', 'account', 'accountType', 'accountHolderName', 'accountHolderDocument', 'accountHolderDocumentType', 'isDefault'])
                    && request.resource.data.bankName is string && request.resource.data.bankName.size() > 0
                    && request.resource.data.bankCode is string && request.resource.data.bankCode.size() > 0
                    && request.resource.data.agency is string && request.resource.data.agency.size() >= 4 && request.resource.data.agency.size() <= 5
                    && request.resource.data.account is string && request.resource.data.account.size() >= 5 && request.resource.data.account.size() <= 12
                    && request.resource.data.accountType is string && (request.resource.data.accountType == "CHECKING" || request.resource.data.accountType == "SAVINGS")
                    && request.resource.data.accountHolderName is string && request.resource.data.accountHolderName.size() >= 3
                    && request.resource.data.accountHolderDocument is string && request.resource.data.accountHolderDocument.size() >= 11 && request.resource.data.accountHolderDocument.size() <= 14
                    && request.resource.data.accountHolderDocumentType is string && (request.resource.data.accountHolderDocumentType == "CPF" || request.resource.data.accountHolderDocumentType == "CNPJ")
                    && request.resource.data.isDefault is bool;
      
      // Atualização: Apenas o dono (com validações)
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && (
                      (
                        request.resource.data.keys().hasAll(['userId', 'bankName', 'bankCode', 'agency', 'account', 'accountType', 'accountHolderName', 'accountHolderDocument', 'accountHolderDocumentType', 'isDefault'])
                        && request.resource.data.userId == request.auth.uid
                        && request.resource.data.bankName is string && request.resource.data.bankName.size() > 0
                        && request.resource.data.bankCode is string && request.resource.data.bankCode.size() > 0
                        && request.resource.data.agency is string && request.resource.data.agency.size() >= 4 && request.resource.data.agency.size() <= 5
                        && request.resource.data.account is string && request.resource.data.account.size() >= 5 && request.resource.data.account.size() <= 12
                        && request.resource.data.accountType is string && (request.resource.data.accountType == "CHECKING" || request.resource.data.accountType == "SAVINGS")
                        && request.resource.data.accountHolderName is string && request.resource.data.accountHolderName.size() >= 3
                        && request.resource.data.accountHolderDocument is string && request.resource.data.accountHolderDocument.size() >= 11 && request.resource.data.accountHolderDocument.size() <= 14
                        && request.resource.data.accountHolderDocumentType is string && (request.resource.data.accountHolderDocumentType == "CPF" || request.resource.data.accountHolderDocumentType == "CNPJ")
                        && request.resource.data.isDefault is bool
                      )
                      ||
                      (
                        request.resource.data.keys().hasOnly(['isDefault']) &&
                        request.resource.data.isDefault is bool
                      )
                    );
      
      allow delete: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
    }
    
    // ==========================================
    // AI CONVERSATIONS COLLECTION
    // ==========================================
    
    match /ai_usage/{usageId} {
      // Leitura: Apenas o dono
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Escrita: Apenas Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // MODERATION LOGS COLLECTION
    // ==========================================
    
    match /moderation_logs/{logId} {
      // Apenas admins podem ler
      allow read: if isAdmin();
      
      // Escrita: Apenas Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // DEFAULT DENY ALL
    // ==========================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
