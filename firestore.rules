rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Obtém o role do usuário através de Custom Claims (autoridade única)
    function getUserRole() {
      return request.auth.token.role;
    }
    
    // Verifica se o usuário é admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Verifica se o usuário é moderador ou admin
    function isModeratorOrAdmin() {
      return isAuthenticated() && (getUserRole() == 'moderator' || getUserRole() == 'admin');
    }
    
    // Verifica se o usuário é o dono do recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==========================================
    // USERS COLLECTION - ISOLAMENTO COMPLETO
    // ==========================================
    
    match /users/{userId} {
      // Leitura: Apenas o próprio usuário, moderadores e admins
      // BLOQUEIA queries de listagem que retornariam dados de outros usuários
      allow read: if isOwner(userId) || isModeratorOrAdmin();
      
      // Criação: Apenas o próprio usuário pode criar seu documento inicial
      allow create: if isOwner(userId) 
                    && request.resource.data.uid == userId
                    && request.resource.data.keys().hasAll(['uid', 'email']);
      
      // Atualização: Apenas o próprio usuário pode atualizar (exceto role)
      allow update: if isOwner(userId)
                    && !('role' in request.resource.data.diff(resource.data).affectedKeys())
                    && !('roleUpdatedAt' in request.resource.data.diff(resource.data).affectedKeys())
                    && !('roleUpdatedBy' in request.resource.data.diff(resource.data).affectedKeys());
      
      // Admins podem atualizar qualquer campo
      allow update: if isAdmin();
      
      // Exclusão: Apenas admins (via Cloud Function)
      allow delete: if isAdmin();
      
      // ==========================================
      // SUBCOLEÇÕES PRIVADAS DO USUÁRIO
      // ==========================================
      
      // ORDERS - Pedidos privados do usuário
      match /orders/{orderId} {
        // Leitura: Apenas o dono (cliente ou prestador relacionado)
        allow read: if isOwner(userId) 
                    || (isAuthenticated() && (
                        resource.data.clientId == request.auth.uid 
                        || resource.data.providerId == request.auth.uid
                        || isAdmin()
                      ));
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
      }
      
      // PRODUCTS - Produtos privados do usuário
      match /products/{productId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
      }
      
      // SERVICES - Serviços privados do usuário
      match /services/{serviceId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
      }
      
      // PURCHASE_ORDERS - Pedidos de compra privados
      match /purchase_orders/{orderId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
      }
      
      // CONVERSATIONS - Conversas privadas do usuário
      match /conversations/{conversationId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
        
        // Mensagens dentro da conversa
        match /messages/{messageId} {
          // Leitura: Apenas o dono da conversa
          allow read: if isOwner(userId);
          
          // Escrita: BLOQUEADA - usar Cloud Functions
          allow write: if false;
        }
      }
      
      // NOTIFICATIONS - Notificações privadas
      match /notifications/{notificationId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
      }
      
      // REVIEWS - Avaliações privadas do usuário
      match /reviews/{reviewId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
      }
      
      // PREFERENCES - Preferências privadas
      match /preferences/{preferenceId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
      }
      
      // SETTINGS - Configurações privadas
      match /settings/{settingId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: BLOQUEADA - usar Cloud Functions
        allow write: if false;
      }
      
      // POSTS - Posts do usuário
      match /posts/{postId} {
        // Leitura: Qualquer usuário autenticado (feed público)
        allow read: if isAuthenticated();
        
        // Criação: Apenas o dono
        allow create: if isOwner(userId) 
                      && request.resource.data.userId == userId;
        
        // Atualização/Exclusão: Apenas o dono
        allow update, delete: if isOwner(userId) 
                              && resource.data.userId == userId;
        
        // Subcoleções do post
        match /comments/{commentId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated() 
                        && request.resource.data.userId == request.auth.uid
                        && request.resource.data.postId == postId;
          allow update, delete: if isAuthenticated() 
                                && resource.data.userId == request.auth.uid;
        }
        
        match /ratings/{ratingId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated() 
                        && request.resource.data.userId == request.auth.uid
                        && request.resource.data.postId == postId
                        && request.resource.data.rating is int
                        && request.resource.data.rating >= 1
                        && request.resource.data.rating <= 5;
          allow update, delete: if isAuthenticated() 
                                && resource.data.userId == request.auth.uid;
        }
      }
      
      // STORIES - Stories do usuário
      match /stories/{storyId} {
        // Leitura: Qualquer usuário autenticado (feed de stories)
        allow read: if isAuthenticated();
        
        // Escrita: BLOQUEADA - usar Cloud Function (createStory)
        allow write: if false;
      }
      
      // BLOCKED_USERS - Usuários bloqueados (privado)
      match /blockedUsers/{blockId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: Apenas o dono
        allow write: if isOwner(userId);
      }
      
      // POST_INTERESTS - Interesses em posts (privado)
      match /postInterests/{interestId} {
        // Leitura: Apenas o dono
        allow read: if isOwner(userId);
        
        // Escrita: Apenas o dono
        allow write: if isOwner(userId);
      }
    }
    
    // ==========================================
    // CONVERSATIONS COLLECTION (raiz) - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /conversations/{conversationId} {
      // Leitura: Apenas o dono da conversa
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Criação: Apenas Cloud Functions
      allow create: if false;
      
      // Atualização: Apenas o dono
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
      
      // Exclusão: Apenas o dono
      allow delete: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
      
      // Mensagens dentro da conversa
      match /messages/{messageId} {
        // Leitura: Apenas o dono da conversa
        allow read: if isAuthenticated() 
                    && get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId == request.auth.uid;
        
        // Escrita: Apenas Cloud Functions
        allow write: if false;
      }
    }
    
    // ==========================================
    // NOTIFICATIONS COLLECTION (raiz) - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /notifications/{notificationId} {
      // Leitura: Apenas o dono
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Escrita: Apenas Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // PRODUCTS COLLECTION (pública) - Apenas produtos ativos
    // ==========================================
    
    match /products/{productId} {
      // Leitura: Qualquer usuário autenticado pode ler produtos ativos
      allow read: if isAuthenticated() 
                  && (resource == null || resource.data.active == true);
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // SERVICES COLLECTION (pública) - Apenas serviços ativos
    // ==========================================
    
    match /services/{serviceId} {
      // Leitura: Qualquer usuário autenticado pode ler serviços ativos
      allow read: if isAuthenticated() 
                  && (resource == null || resource.data.active == true);
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // ORDERS COLLECTION (pública) - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /orders/{orderId} {
      // Leitura: Apenas cliente, prestador relacionado ou admins
      allow read: if isAuthenticated() 
                  && (resource.data.clientId == request.auth.uid 
                      || resource.data.providerId == request.auth.uid
                      || isAdmin());
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // PURCHASE_ORDERS COLLECTION - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /purchase_orders/{orderId} {
      // Leitura: Apenas o comprador ou vendedor relacionado
      allow read: if isAuthenticated() 
                  && (resource.data.buyerId == request.auth.uid 
                      || resource.data.sellerId == request.auth.uid
                      || isAdmin());
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // SHIPMENTS COLLECTION - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /shipments/{shipmentId} {
      // Leitura: Apenas o dono do pedido relacionado
      allow read: if isAuthenticated() 
                  && (resource.data.userId == request.auth.uid
                      || resource.data.orderUserId == request.auth.uid
                      || isAdmin());
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // POSTS COLLECTION (raiz) - Feed público
    // ==========================================
    
    match /posts/{postId} {
      // Leitura: Qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Criação: Apenas o próprio usuário
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      
      // Atualização/Exclusão: Apenas o dono
      allow update, delete: if isAuthenticated() 
                            && resource.data.userId == request.auth.uid;
      
      // Subcoleções
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() 
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.postId == postId;
        allow update, delete: if isAuthenticated() 
                              && resource.data.userId == request.auth.uid;
      }
      
      match /ratings/{ratingId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() 
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.postId == postId
                      && request.resource.data.rating is int
                      && request.resource.data.rating >= 1
                      && request.resource.data.rating <= 5;
        allow update, delete: if isAuthenticated() 
                              && resource.data.userId == request.auth.uid;
      }
    }
    
    // ==========================================
    // STORIES COLLECTION (raiz) - Feed público
    // ==========================================
    
    match /stories/{storyId} {
      // Leitura: Qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: BLOQUEADA - usar Cloud Function (createStory)
      allow write: if false;
      
      // Visualizações
      match /views/{userId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() 
                      && request.auth.uid == userId;
        allow update, delete: if false;
      }
    }
    
    // ==========================================
    // REVIEWS COLLECTION - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /reviews/{reviewId} {
      // Leitura: Qualquer usuário autenticado (reviews são públicas)
      allow read: if isAuthenticated();
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // BANK_ACCOUNTS COLLECTION - ISOLAMENTO COMPLETO
    // ==========================================
    
    match /bank_accounts/{accountId} {
      // Leitura: Apenas o dono
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Criação: Apenas o próprio usuário (com validações)
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['userId', 'bankName', 'bankCode', 'agency', 'account', 'accountType', 'accountHolderName', 'accountHolderDocument', 'accountHolderDocumentType', 'isDefault'])
                    && request.resource.data.bankName is string && request.resource.data.bankName.size() > 0
                    && request.resource.data.bankCode is string && request.resource.data.bankCode.size() > 0
                    && request.resource.data.agency is string && request.resource.data.agency.size() >= 4 && request.resource.data.agency.size() <= 5
                    && request.resource.data.account is string && request.resource.data.account.size() >= 5 && request.resource.data.account.size() <= 12
                    && request.resource.data.accountType is string && (request.resource.data.accountType == "CHECKING" || request.resource.data.accountType == "SAVINGS")
                    && request.resource.data.accountHolderName is string && request.resource.data.accountHolderName.size() >= 3
                    && request.resource.data.accountHolderDocument is string && request.resource.data.accountHolderDocument.size() >= 11 && request.resource.data.accountHolderDocument.size() <= 14
                    && request.resource.data.accountHolderDocumentType is string && (request.resource.data.accountHolderDocumentType == "CPF" || request.resource.data.accountHolderDocumentType == "CNPJ")
                    && request.resource.data.isDefault is bool;
      
      // Atualização: Apenas o dono (com validações)
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && (
                      (
                        request.resource.data.keys().hasAll(['userId', 'bankName', 'bankCode', 'agency', 'account', 'accountType', 'accountHolderName', 'accountHolderDocument', 'accountHolderDocumentType', 'isDefault'])
                        && request.resource.data.userId == request.auth.uid
                        && request.resource.data.bankName is string && request.resource.data.bankName.size() > 0
                        && request.resource.data.bankCode is string && request.resource.data.bankCode.size() > 0
                        && request.resource.data.agency is string && request.resource.data.agency.size() >= 4 && request.resource.data.agency.size() <= 5
                        && request.resource.data.account is string && request.resource.data.account.size() >= 5 && request.resource.data.account.size() <= 12
                        && request.resource.data.accountType is string && (request.resource.data.accountType == "CHECKING" || request.resource.data.accountType == "SAVINGS")
                        && request.resource.data.accountHolderName is string && request.resource.data.accountHolderName.size() >= 3
                        && request.resource.data.accountHolderDocument is string && request.resource.data.accountHolderDocument.size() >= 11 && request.resource.data.accountHolderDocument.size() <= 14
                        && request.resource.data.accountHolderDocumentType is string && (request.resource.data.accountHolderDocumentType == "CPF" || request.resource.data.accountHolderDocumentType == "CNPJ")
                        && request.resource.data.isDefault is bool
                      )
                      ||
                      (
                        request.resource.data.keys().hasOnly(['isDefault']) &&
                        request.resource.data.isDefault is bool
                      )
                    );
      
      // Exclusão: Apenas o dono
      allow delete: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
    }
    
    // ==========================================
    // AI_USAGE COLLECTION - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /ai_usage/{usageId} {
      // Leitura: Apenas o dono
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Escrita: Apenas Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // ACCOUNT_CHANGE_REQUESTS - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /account_change_requests/{requestId} {
      // Leitura: Apenas o dono
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // IDENTITY_VERIFICATIONS - ISOLAMENTO POR USUÁRIO
    // ==========================================
    
    match /identity_verifications/{verificationId} {
      // Leitura: Apenas o dono ou admins
      allow read: if isAuthenticated() 
                  && (resource.data.userId == request.auth.uid || isAdmin());
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // TWO_FACTOR_CODES - ISOLAMENTO COMPLETO
    // ==========================================
    
    match /two_factor_codes/{codeId} {
      // Leitura: Apenas o dono
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Escrita: BLOQUEADA - usar Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // CATEGORIES COLLECTIONS (públicas)
    // ==========================================
    
    match /product_categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /service_categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ==========================================
    // HOME BANNERS COLLECTION (pública)
    // ==========================================
    
    match /homeBanners/{bannerId} {
      allow read: if isAuthenticated() 
                  && (resource == null || resource.data.active == true);
      allow write: if isAdmin();
    }
    
    // ==========================================
    // STORY_VIEWS COLLECTION (raiz)
    // ==========================================
    
    match /story_views/{storyId} {
      allow read: if isAuthenticated();
      allow write: if false;
      
      match /views/{userId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if false;
      }
    }
    
    // ==========================================
    // MODERATION_LOGS COLLECTION - Apenas admins
    // ==========================================
    
    match /moderation_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ==========================================
    // DEFAULT DENY ALL - Segurança máxima
    // ==========================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
